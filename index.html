// PPDD Website - Single File React Component (No Wallet/MetaMask dependencies)
// Goal: Professional but casual site, resilient to environments where other scripts
// might attempt wallet connections. Includes ErrorBoundary and a tiny in-browser
// self-test suite so we can confirm the page renders and that we do NOT auto-connect
// to any crypto wallet.

import { useEffect, useMemo, useRef, useState } from "react";

/********************
 * Error Boundary
 ********************/
function ErrorBoundary({ children }) {
  const [error, setError] = useState(null);
  if (error) {
    return (
      <div className="min-h-screen bg-red-50 text-red-900 p-6">
        <div className="max-w-3xl mx-auto">
          <h1 className="text-2xl font-bold">Something went wrong</h1>
          <p className="mt-2">The UI kept running into an error. We caught it so the whole site doesn't crash.</p>
          <details className="mt-4 p-4 bg-white rounded-xl shadow">
            <summary className="cursor-pointer font-semibold">Error details</summary>
            <pre className="whitespace-pre-wrap text-sm mt-3">{String(error?.stack || error?.message || error)}</pre>
          </details>
          <button
            className="mt-6 px-4 py-2 rounded-lg bg-gray-900 text-white"
            onClick={() => location.reload()}
          >
            Reload
          </button>
        </div>
      </div>
    );
  }
  return (
    <ErrorCatcher onError={setError}>{children}</ErrorCatcher>
  );
}

function ErrorCatcher({ children, onError }) {
  useEffect(() => {
    const handler = (event) => {
      // Intercept unhandled runtime errors so we can show a friendly screen
      if (event?.error) {
        onError(event.error);
      }
    };
    const rej = (event) => {
      if (event?.reason instanceof Error) onError(event.reason);
    };
    window.addEventListener("error", handler);
    window.addEventListener("unhandledrejection", rej);
    return () => {
      window.removeEventListener("error", handler);
      window.removeEventListener("unhandledrejection", rej);
    };
  }, [onError]);
  return children;
}

/********************
 * MetaMask/Wallet Guard (non-invasive)
 * - We DO NOT connect to MetaMask.
 * - If any 3rd-party script elsewhere throws a MetaMask error, we surface it politely.
 ********************/
function useWalletGuard() {
  const [walletIssue, setWalletIssue] = useState(null);
  useEffect(() => {
    const markIfMetaMask = (msg) => {
      const s = String(msg || "").toLowerCase();
      if (s.includes("metamask") || s.includes("wallet")) {
        setWalletIssue(msg);
      }
    };
    const onErr = (e) => markIfMetaMask(e?.error?.message || e?.message || e);
    const onRej = (e) => markIfMetaMask(e?.reason?.message || e?.reason || e);
    window.addEventListener("error", onErr);
    window.addEventListener("unhandledrejection", onRej);
    return () => {
      window.removeEventListener("error", onErr);
      window.removeEventListener("unhandledrejection", onRej);
    };
  }, []);
  return walletIssue;
}

/********************
 * Tiny Self-Test Panel (in-page, no libs)
 ********************/
function SelfTests() {
  const [results, setResults] = useState(null);
  const [open, setOpen] = useState(false);
  const run = () => {
    const cases = [
      {
        name: "Header renders brand",
        test: () => !!document.querySelector("header .ppdd-brand"),
      },
      {
        name: "Sections exist (services/about/contact)",
        test: () =>
          ["#services", "#about", "#contact"].every((sel) => !!document.querySelector(sel)),
      },
      {
        name: "No auto wallet connect flag",
        test: () => window.__ppdd_walletConnectAttempted !== true,
      },
      {
        name: "CTA buttons present",
        test: () =>
          Array.from(document.querySelectorAll("button,a")).some((el) => /let’s talk|email us/i.test(el.textContent || "")),
      },
    ];
    const out = cases.map((c) => {
      let pass = false;
      let err = null;
      try {
        pass = !!c.test();
      } catch (e) {
        err = e;
      }
      return { name: c.name, pass, err };
    });
    setResults(out);
  };
  useEffect(() => {
    // Auto-run tests if URL has ?dev=1
    if (typeof window !== "undefined" && new URLSearchParams(location.search).get("dev") === "1") {
      setOpen(true);
      run();
    }
  }, []);
  return (
    <div className="fixed bottom-4 right-4 z-50">
      <button
        onClick={() => setOpen((v) => !v)}
        className="px-3 py-2 rounded-lg shadow bg-white border border-gray-200 text-sm"
      >
        {open ? "Close" : "Open"} Dev Panel
      </button>
      {open && (
        <div className="mt-2 w-80 max-w-[90vw] bg-white rounded-2xl shadow-xl border border-gray-200 p-3">
          <div className="flex items-center justify-between">
            <h4 className="font-semibold">Self Tests</h4>
            <button onClick={run} className="text-xs px-2 py-1 rounded bg-gray-900 text-white">Run</button>
          </div>
          <div className="mt-2 text-xs text-gray-600">
            Quick checks that the page renders and no wallet auto-connect is attempted.
          </div>
          {results && (
            <ul className="mt-3 space-y-2">
              {results.map((r, i) => (
                <li key={i} className={`p-2 rounded ${r.pass ? "bg-green-50" : "bg-red-50"}`}>
                  <div className="font-medium">{r.name}</div>
                  <div className="text-xs mt-1">{r.pass ? "PASS" : "FAIL"}</div>
                  {!r.pass && r.err && (
                    <pre className="mt-1 text-[10px] whitespace-pre-wrap">{String(r.err)}</pre>
                  )}
                </li>
              ))}
            </ul>
          )}
        </div>
      )}
    </div>
  );
}

/********************
 * UI Bits
 ********************/
function Section({ id, className = "", children }) {
  return (
    <section id={id} className={`py-16 ${className}`}>{children}</section>
  );
}

function Card({ title, children }) {
  return (
    <div className="shadow-lg rounded-2xl bg-white border border-gray-100">
      <div className="p-6">
        <h4 className="text-xl font-semibold mb-3">{title}</h4>
        <div className="text-gray-700">{children}</div>
      </div>
    </div>
  );
}

function PrimaryButton({ as: As = "button", href, onClick, children }) {
  const className = "inline-flex items-center justify-center px-5 py-3 rounded-xl bg-blue-600 text-white font-medium hover:bg-blue-700 transition";
  return href ? (
    <As href={href} className={className} onClick={onClick}>{children}</As>
  ) : (
    <button className={className} onClick={onClick}>{children}</button>
  );
}

function GhostLink({ href, children }) {
  return (
    <a href={href} className="hover:text-blue-600 transition">{children}</a>
  );
}

/********************
 * Main App
 ********************/
export default function Home() {
  // Prevent any accidental wallet auto-connect attempts from this file.
  // (External scripts may still try; our guard will surface that politely.)
  useEffect(() => {
    window.__ppdd_walletConnectAttempted = false;
  }, []);

  const walletIssue = useWalletGuard();
  const year = useMemo(() => new Date().getFullYear(), []);
  const contactRef = useRef(null);

  const scrollToContact = () => {
    contactRef.current?.scrollIntoView({ behavior: "smooth" });
  };

  return (
    <ErrorBoundary>
      <div className="min-h-screen bg-gray-50 text-gray-800">
        {/* Header */}
        <header className="bg-white shadow-md p-6 flex justify-between items-center sticky top-0 z-40">
          <h1 className="ppdd-brand text-2xl font-bold text-blue-600">Ping Pong Deep Dive, LLC</h1>
          <nav className="space-x-6 text-sm">
            <GhostLink href="#services">Services</GhostLink>
            <GhostLink href="#about">About</GhostLink>
            <GhostLink href="#contact">Contact</GhostLink>
          </nav>
        </header>

        {/* Hero */}
        <Section className="text-center bg-gradient-to-r from-blue-50 to-blue-100">
          <h2 className="text-4xl font-extrabold text-gray-900">Business Intelligence, Simplified</h2>
          <p className="mt-4 text-lg max-w-2xl mx-auto">
            At PPDD, we take the complexity out of data and serve up insights that hit home—like a perfect ping pong rally.
          </p>
          <div className="mt-6 flex justify-center gap-3">
            <PrimaryButton onClick={scrollToContact}>Let’s Talk</PrimaryButton>
            <a href="#services" className="px-5 py-3 rounded-xl bg-white border border-gray-200 hover:bg-gray-50">Explore Services</a>
          </div>
        </Section>

        {/* Optional wallet warning if some other script in the environment errors out */}
        {walletIssue && (
          <div className="max-w-4xl mx-auto px-6">
            <div className="p-4 rounded-xl bg-yellow-50 border border-yellow-200 text-yellow-900">
              <div className="font-semibold">Heads up</div>
              <p className="text-sm mt-1">
                We detected a wallet-related error from another script in this environment: <em>{String(walletIssue)}</em>.
                PPDD's site doesn’t require MetaMask or any wallet. The page is safe to use; you can ignore this or disable any wallet auto-connect scripts in your project.
              </p>
            </div>
          </div>
        )}

        {/* Services */}
        <Section id="services" className="max-w-5xl mx-auto px-6">
          <h3 className="text-3xl font-bold text-center mb-10">Our Services</h3>
          <div className="grid md:grid-cols-3 gap-6">
            <Card title="Data Strategy">
              We help you build a roadmap so your data works for you, not against you.
            </Card>
            <Card title="Dashboards">
              Custom dashboards that tell your story at a glance—no jargon, just clarity.
            </Card>
            <Card title="Analytics">
              Dive deep into trends and insights to make smarter decisions, faster.
            </Card>
          </div>
        </Section>

        {/* About */}
        <Section id="about" className="bg-gray-100 px-6">
          <div className="max-w-4xl mx-auto text-center">
            <h3 className="text-3xl font-bold mb-6">About PPDD</h3>
            <p>
              Founded with the belief that data should be approachable, Ping Pong Deep Dive, LLC combines sharp business intelligence with a human touch. We partner with companies big and small to transform numbers into narratives.
            </p>
          </div>
        </Section>

        {/* Contact */}
        <Section id="contact" className="px-6" >
          <div ref={contactRef} className="max-w-3xl mx-auto text-center">
            <h3 className="text-3xl font-bold mb-6">Let’s Connect</h3>
            <p className="mb-6">Whether you’re curious or ready to dive in, we’d love to hear from you.</p>
            <div className="flex items-center justify-center gap-3 flex-wrap">
              <PrimaryButton as="a" href="mailto:hello@pingpongdeepdive.com?subject=PPDD%20Inquiry">Email Us</PrimaryButton>
              <a
                href="https://cal.com/"
                target="_blank"
                rel="noreferrer"
                className="px-5 py-3 rounded-xl bg-white border border-gray-200 hover:bg-gray-50"
              >
                Book a Call
              </a>
            </div>
          </div>
        </Section>

        {/* Footer */}
        <footer className="bg-gray-900 text-gray-200 text-center py-6 mt-10">
          <p>© {year} Ping Pong Deep Dive, LLC. All rights reserved.</p>
        </footer>

        {/* Dev/Test panel */}
        <SelfTests />
      </div>
    </ErrorBoundary>
  );
}
